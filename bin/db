#!/usr/bin/env ruby
require "thor"


def import_cmd(db, occurrences_tsv)
  <<~HEREDOC
  sqlite3 #{db} <<EOF
  .mode tabs
  .import #{occurrences_tsv} occurrences
  EOF
  HEREDOC
end

class MyCLI < Thor
  def self.exit_on_failure?
    true
  end

  desc "populate_test", "reset and populate test database with test data"
  def populate_test
    invoke :populate, ['test', 'test/data/reptilia_gbif_occurrences.tsv']
  end

  desc "populate_db RAILS_ENV OCCURRENCES_TSV_PATH", "reset and populate specified database with data"
  def populate(rails_env, occurrences_tsv_path)
    ENV['RAILS_ENV'] = rails_env
    system('bin/rake db:reset')
    system(import_cmd("db/#{rails_env}.sqlite3", occurrences_tsv_path))
    system("bin/rails r 'Occurrence.update_all_species_metrics'")
  end
end

MyCLI.start(ARGV)
